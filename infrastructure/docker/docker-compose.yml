# AIOT Microservices Architecture with Express.js API Gateway
# 微服務架構 Docker Compose 配置

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

x-common-env: &common-env
  NODE_ENV: development
  # MySQL 通用配置
  DB_PORT: 3306
  DB_USER: admin
  DB_PASSWORD: admin
  # MongoDB 配置
  MONGODB_URL: mongodb://admin:admin@aiot-mongodb:27017/main_db?authSource=admin
  # Redis 配置
  REDIS_HOST: aiot-redis
  REDIS_PORT: 6379
  REDIS_DB: 0
  REDIS_URL: redis://aiot-redis:6379/0
  # RabbitMQ 配置
  RABBITMQ_URL: amqp://admin:admin@aiot-rabbitmq:5672/
  # Consul 配置
  CONSUL_HOST: consul
  CONSUL_PORT: 8500
  # JWT 配置
  JWT_SECRET: zanewnch
  JWT_EXPIRES_IN: 24h
  
  # ========== Microservice 間通訊配置 ==========
  # RBAC 服務
  RBAC_SERVICE_HOST: aiot-rbac-service
  RBAC_SERVICE_PORT: 50051
  RBAC_SERVICE_URL: aiot-rbac-service:50051
  
  # Drone 服務
  DRONE_SERVICE_HOST: aiot-drone-service
  DRONE_SERVICE_PORT: 50052
  DRONE_SERVICE_URL: aiot-drone-service:50052
  
  # General 服務
  GENERAL_SERVICE_HOST: aiot-general-service
  GENERAL_SERVICE_PORT: 50053
  GENERAL_SERVICE_URL: aiot-general-service:50053
  
  # Drone WebSocket 服務
  DRONE_WEBSOCKET_SERVICE_HOST: aiot-drone-websocket-service
  DRONE_WEBSOCKET_SERVICE_PORT: 3004
  DRONE_WEBSOCKET_SERVICE_URL: http://aiot-drone-websocket-service:3004
  
  # Scheduler 服務
  SCHEDULER_SERVICE_HOST: aiot-scheduler-service
  SCHEDULER_SERVICE_PORT: 3001
  SCHEDULER_SERVICE_URL: http://aiot-scheduler-service:3001
  
  # Archive Processor 服務
  ARCHIVE_PROCESSOR_SERVICE_HOST: aiot-archive-processor-service
  ARCHIVE_PROCESSOR_SERVICE_PORT: 3005
  ARCHIVE_PROCESSOR_SERVICE_URL: http://aiot-archive-processor-service:3005

services:
  # ==========================================================================
  # 基礎設施服務 (Infrastructure Services)
  # ==========================================================================
  
  # Consul 服務發現
  consul:
    build:
      context: ../consul
      dockerfile: Dockerfile.dev
    logging: *default-logging
    container_name: aiot-consul
    ports:
      - "8500:8500"  # HTTP API & UI
      - "8600:8600/udp"  # DNS
    environment:
      - CONSUL_BIND_INTERFACE=eth0
    volumes:
      - consul_data:/consul/data
      - ../consul/consul.json:/consul/config/consul.json:ro
    networks:
      - aiot-network
    restart: unless-stopped
    # 修復權限問題：添加必要的 capabilities 和安全設定
    cap_add:
      - SETGID
      - SETUID
    security_opt:
      - no-new-privileges:false
    user: "0:0"  # 使用 root 用戶避免 setgroups 權限問題
    healthcheck:
      # 檢查 Consul 集群成員狀態和服務註冊功能
      # 確保 Consul 節點正常運行並可以進行服務發現
      test: ["CMD", "consul", "members"]
      interval: 10s
      timeout: 5s
      retries: 3




  # ==========================================================================
  # 資料庫服務 (Database Services)
  # ==========================================================================

  # RBAC 微服務專用 MySQL 資料庫
  aiot-rbac-mysql:
    image: mysql:8.0
    logging: *default-logging
    container_name: aiot-rbac-mysql
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=admin
      - MYSQL_USER=admin
      - MYSQL_PASSWORD=admin
      - MYSQL_DATABASE=rbac_db
      - TZ=Asia/Taipei
      # 跳過時區資訊初始化以加快啟動速度
      - MYSQL_INITDB_SKIP_TZINFO=1
    volumes:
      - mysql_rbac_data:/var/lib/mysql
      # RBAC 專用初始化腳本
      - ../database/mysql/00_databases_creation.sql:/docker-entrypoint-initdb.d/00_databases_creation.sql:ro
      - ../database/mysql/01_rbac_complete_init.sql:/docker-entrypoint-initdb.d/01_rbac_complete_init.sql:ro
    networks:
      - aiot-network
    restart: unless-stopped
    healthcheck:
      # 檢查 MySQL 資料庫連線狀態和認證功能
      # 確保 RBAC 服務的專用資料庫可以正常連線和查詢
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "admin", "-padmin"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Drone 微服務專用 MySQL 資料庫
  aiot-drone-mysql:
    image: mysql:8.0
    logging: *default-logging
    container_name: aiot-drone-mysql
    ports:
      - "3307:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=admin
      - MYSQL_USER=admin
      - MYSQL_PASSWORD=admin
      - MYSQL_DATABASE=drone_db
      - TZ=Asia/Taipei
      # 跳過時區資訊初始化以加快啟動速度
      - MYSQL_INITDB_SKIP_TZINFO=1
    volumes:
      - mysql_drone_data:/var/lib/mysql
      # Drone 專用初始化腳本
      - ../database/mysql/00_databases_creation.sql:/docker-entrypoint-initdb.d/00_databases_creation.sql:ro
      - ../database/mysql/02_drone_complete_init.sql:/docker-entrypoint-initdb.d/02_drone_complete_init.sql:ro
    networks:
      - aiot-network
    restart: unless-stopped
    healthcheck:
      # 檢查 MySQL 資料庫連線狀態和認證功能
      # 確保 Drone 服務的專用資料庫可以正常連線和查詢
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "admin", "-padmin"]
      interval: 10s
      timeout: 5s
      retries: 5

  # General 微服務專用 MySQL 資料庫
  aiot-general-mysql:
    image: mysql:8.0
    logging: *default-logging
    container_name: aiot-general-mysql
    ports:
      - "3308:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=admin
      - MYSQL_USER=admin
      - MYSQL_PASSWORD=admin
      - MYSQL_DATABASE=user_preference_db
      - TZ=Asia/Taipei
      # 跳過時區資訊初始化以加快啟動速度
      - MYSQL_INITDB_SKIP_TZINFO=1
    volumes:
      - mysql_general_data:/var/lib/mysql
      # General 專用初始化腳本
      - ../database/mysql/00_databases_creation.sql:/docker-entrypoint-initdb.d/00_databases_creation.sql:ro
      - ../database/mysql/03_user_preferences_init.sql:/docker-entrypoint-initdb.d/03_user_preferences_init.sql:ro
    networks:
      - aiot-network
    restart: unless-stopped
    healthcheck:
      # 檢查 MySQL 資料庫連線狀態和認證功能
      # 確保 General 服務的專用資料庫可以正常連線和查詢
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "admin", "-padmin"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 共享 MySQL 資料庫（用於跨服務共享数據）
  aiot-shared-mysql:
    build:
      context: ../database
      dockerfile: Dockerfile.dev
    logging: *default-logging
    container_name: aiot-shared-mysql
    ports:
      - "3309:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=admin
      - MYSQL_USER=admin
      - MYSQL_PASSWORD=admin
      - MYSQL_DATABASE=main_db
      - TZ=Asia/Taipei
      # 跳過時區資訊初始化以加快啟動速度
      - MYSQL_INITDB_SKIP_TZINFO=1
    volumes:
      - mysql_shared_data:/var/lib/mysql
      # 基礎初始化腳本
      - ../database/mysql/00_databases_creation.sql:/docker-entrypoint-initdb.d/00_databases_creation.sql:ro
    networks:
      - aiot-network
    restart: unless-stopped
    healthcheck:
      # 檢查 MySQL 資料庫連線狀態和認證功能
      # 確保共享資料庫可以正常連線，供跨服務數據共享使用
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "admin", "-padmin"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MongoDB 資料庫
  aiot-mongodb:
    image: mongo:7.0
    logging: *default-logging
    container_name: aiot-mongodb
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=admin
      - MONGO_INITDB_DATABASE=main_db
    volumes:
      - mongodb_data:/data/db
    networks:
      - aiot-network
    restart: unless-stopped
    healthcheck:
      # 檢查 MongoDB 資料庫連線和認證狀態
      # 執行 ping 命令確保 MongoDB 服務正常運行並可接受查詢請求
      test: ["CMD", "mongosh", "-u", "admin", "-p", "admin", "--authenticationDatabase", "admin", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis 快取服務
  aiot-redis:
    image: redis:7-alpine
    logging: *default-logging
    container_name: aiot-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - aiot-network
    restart: unless-stopped
    healthcheck:
      # 檢查 Redis 快取服務的連線狀態
      # 確保 Redis 可以正常接收和處理快取請求，支援微服務的階段式存取
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # RabbitMQ 消息隊列
  aiot-rabbitmq:
    build:
      context: ../rabbitmq
      dockerfile: Dockerfile.dev
    logging: *default-logging
    container_name: aiot-rabbitmq
    ports:
      - "5672:5672"   # AMQP
      - "15672:15672" # Management UI
    environment:
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=admin
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - ../rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ../rabbitmq/definitions.json:/etc/rabbitmq/definitions.json:ro
    networks:
      - aiot-network
    restart: unless-stopped
    healthcheck:
      # 檢查 RabbitMQ 消息隊列服務狀態
      # 確保消息隊列可以正常接收和處理消息，微服務間異步通訊正常
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ==========================================================================
  # 微服務 (Microservices)
  # ==========================================================================

  # Auth 微服務 (gRPC + HTTP) - 專門處理認證功能
  auth-service:
    build:
      context: ../../microServices/auth-service
      dockerfile: Dockerfile.dev
    logging: *default-logging
    container_name: aiot-auth-service
    ports:
      - "50055:50055" # gRPC for inter-service communication
      - "3055:3055"   # HTTP API endpoint
    environment:
      <<: *common-env
      SERVICE_NAME: auth-service
      GRPC_PORT: 50055
      HTTP_PORT: 3055
      # Auth 使用 RBAC 資料庫（共享用戶表）
      DB_HOST: aiot-rbac-mysql
      DB_NAME: rbac_db
    volumes:
      - ../../microServices/auth-service:/app
      - /app/node_modules
    networks:
      - aiot-network
    depends_on:
      consul:
        condition: service_healthy
      aiot-rbac-mysql:
        condition: service_healthy
      aiot-redis:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      # 檢查 Auth 微服務的 HTTP API 端點健康狀態
      # 確保認證服務正常運行，可以處理用戶登入登出請求
      test: ["CMD", "curl", "-f", "http://localhost:3055/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # RBAC 微服務 (gRPC + HTTP) - 專門處理角色權限管理
  rbac-service:
    build:
      context: ../../microServices/rbac-service
      dockerfile: Dockerfile.dev
    logging: *default-logging
    container_name: aiot-rbac-service
    ports:
      - "50051:50051" # gRPC for inter-service communication
      - "3051:3051"   # HTTP API endpoint
    environment:
      <<: *common-env
      SERVICE_NAME: rbac-service
      GRPC_PORT: 50051
      HTTP_PORT: 3051
      # RBAC 專用資料庫配置
      DB_HOST: aiot-rbac-mysql
      DB_NAME: rbac_db
    volumes:
      - ../../microServices/rbac-service:/app
      - /app/node_modules
    networks:
      - aiot-network
    depends_on:
      consul:
        condition: service_healthy
      aiot-rbac-mysql:
        condition: service_healthy
      aiot-redis:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      # 檢查 RBAC 微服務的 HTTP API 端點健康狀態
      # 確保權限認證服務正常運行，可以處理用戶權限驗證請求
      test: ["CMD", "curl", "-f", "http://localhost:3051/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Drone API 微服務 (gRPC + HTTP)
  drone-service:
    build:
      context: ../../microServices/drone-service
      dockerfile: Dockerfile.dev
    logging: *default-logging
    container_name: aiot-drone-service
    ports:
      - "50052:50052" # gRPC for inter-service communication
      - "3052:3052"   # HTTP API endpoint
    environment:
      <<: *common-env
      SERVICE_NAME: drone-service
      GRPC_PORT: 50052
      HTTP_PORT: 3052
      # Drone 專用資料庫配置
      DB_HOST: aiot-drone-mysql
      DB_NAME: drone_db
    volumes:
      - ../../microServices/drone-service:/app
      - /app/node_modules
    networks:
      - aiot-network
    depends_on:
      consul:
        condition: service_healthy
      aiot-drone-mysql:
        condition: service_healthy
      aiot-redis:
        condition: service_started
      aiot-rabbitmq:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      # 檢查 Drone 微服務的 HTTP API 端點健康狀態
      # 確保無人機管理服務正常運行，可以處理無人機相關的 API 請求
      test: ["CMD", "curl", "-f", "http://localhost:3052/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Drone WebSocket 微服務 (專門處理 WebSocket)
  drone-websocket-service:
    build:
      context: ../../microServices/drone-websocket-service
      dockerfile: Dockerfile.dev
    logging: *default-logging
    container_name: aiot-drone-websocket-service
    ports:
      - "3004:3004"   # WebSocket 服務
    environment:
      <<: *common-env
      SERVICE_NAME: drone-websocket-service
      SERVICE_PORT: 3004
      # Drone 專用資料庫配置（共享 Drone DB）
      DB_HOST: aiot-drone-mysql
      DB_NAME: drone_db
      # CORS 配置
      CORS_ORIGIN: "*"
    volumes:
      - ../../microServices/drone-websocket-service:/app
      - /app/node_modules
    networks:
      - aiot-network
    depends_on:
      consul:
        condition: service_healthy
      aiot-drone-mysql:
        condition: service_healthy
      aiot-redis:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      # 檢查 Drone WebSocket 服務的健康狀態
      # 確保無人機即時通訊服務正常，可以處理 WebSocket 連線和即時數據推送
      test: ["CMD", "curl", "-f", "http://localhost:3004/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # General 微服務 (gRPC + HTTP)
  general-service:
    build:
      context: ../../microServices/general-service
      dockerfile: Dockerfile.dev
    logging: *default-logging
    container_name: aiot-general-service
    ports:
      - "50053:50053" # gRPC for inter-service communication
      - "3053:3053"   # HTTP API endpoint
    environment:
      <<: *common-env
      SERVICE_NAME: general-service
      GRPC_PORT: 50053
      HTTP_PORT: 3053
      # General 專用資料庫配置
      DB_HOST: aiot-general-mysql
      DB_NAME: user_preference_db
    volumes:
      - ../../microServices/general-service:/app
      - /app/node_modules
    networks:
      - aiot-network
    depends_on:
      consul:
        condition: service_healthy
      aiot-general-mysql:
        condition: service_healthy
      aiot-redis:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      # 檢查 General 微服務的 HTTP API 端點健康狀態
      # 確保通用服務正常運行，可以處理用戶偏好設定等通用功能請求
      test: ["CMD", "curl", "-f", "http://localhost:3053/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Docs 微服務 (gRPC + HTTP - 文檔聚合服務)
  docs-service:
    build:
      context: ../../microServices/docs-service
      dockerfile: Dockerfile.dev
    logging: *default-logging
    container_name: aiot-docs-service
    ports:
      - "50054:50054" # gRPC for inter-service communication
      - "3054:3054"   # HTTP API endpoint
    environment:
      <<: *common-env
      SERVICE_NAME: docs-service
      GRPC_PORT: 50054
      HTTP_PORT: 3054
      NODE_ENV: development
      # 文檔服務無需資料庫配置
    volumes:
      - ../../microServices/docs-service:/app
      - /app/node_modules
      # 掛載各微服務的文檔目錄
      - ../../microServices/rbac-service/docs:/app/docs/rbac:ro
      - ../../microServices/drone-service/docs:/app/docs/drone:ro
      - ../../microServices/drone-websocket-service/docs:/app/docs/drone-websocket:ro
      - ../../microServices/general-service/docs:/app/docs/general:ro
    networks:
      - aiot-network
    depends_on:
      consul:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      # 檢查 Docs 微服務的 HTTP API 端點健康狀態
      # 確保文檔聚合服務正常運行，可以提供各微服務的 API 文檔查詢
      test: ["CMD", "curl", "-f", "http://localhost:3054/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Scheduler 微服務 (定時任務排程器)
  scheduler-service:
    build:
      context: ../../microServices/scheduler-service
      dockerfile: Dockerfile.dev
    logging: *default-logging
    container_name: aiot-scheduler-service
    ports:
      - "3001:3001"   # HTTP API endpoint
    environment:
      <<: *common-env
      SERVICE_NAME: scheduler-service
      PORT: 3001
      NODE_ENV: development
      # 資料庫配置 (使用 Drone 資料庫存放 archive_tasks 表)
      DB_HOST: aiot-drone-mysql
      DB_PORT: 3306
      DB_NAME: drone_db
      # 日誌設定
      LOG_LEVEL: info
      LOG_DIR: ./logs
      # 排程設定
      CRON_ARCHIVE_DAILY: "0 2 * * *"
      CRON_CLEANUP_EXPIRED: "0 4 * * *"
      TIMEZONE: Asia/Taipei
      # 監控設定
      THRESHOLD_CPU_WARNING: 70
      THRESHOLD_CPU_CRITICAL: 90
      THRESHOLD_MEMORY_WARNING: 80
      THRESHOLD_MEMORY_CRITICAL: 95
    volumes:
      - ../../microServices/scheduler-service:/app
      - /app/node_modules
      - scheduler_logs:/app/logs
    networks:
      - aiot-network
    depends_on:
      consul:
        condition: service_healthy
      aiot-drone-mysql:
        condition: service_healthy
      aiot-redis:
        condition: service_started
      aiot-rabbitmq:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      # 檢查 Scheduler 微服務的 HTTP API 端點健康狀態
      # 確保排程服務正常運行，可以處理定時任務排程和觸發
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Archive Processor 微服務 (歸檔處理器)
  archive-processor-service:
    build:
      context: ../../microServices/archive-processor-service
      dockerfile: Dockerfile.dev
    logging: *default-logging
    container_name: aiot-archive-processor-service
    ports:
      - "3005:3005"   # HTTP API endpoint
    environment:
      <<: *common-env
      SERVICE_NAME: archive-processor-service
      PORT: 3005
      NODE_ENV: development
      # 資料庫配置 (使用 Drone 資料庫)
      DB_HOST: aiot-drone-mysql
      DB_PORT: 3306
      DB_NAME: drone_db
      # 日誌設定
      LOG_LEVEL: info
      LOG_DIR: ./logs
      # 處理器設定
      CONCURRENCY_LIMIT: 3
      MAX_RETRY_ATTEMPTS: 3
      RETRY_DELAY: 300000
      # 批量處理設定
      DEFAULT_BATCH_SIZE: 1000
      BATCH_DELAY_MS: 100
      CLEANUP_MAX_EXECUTION_HOURS: 2
    volumes:
      - ../../microServices/archive-processor-service:/app
      - /app/node_modules
      - archive_processor_logs:/app/logs
    networks:
      - aiot-network
    depends_on:
      consul:
        condition: service_healthy
      aiot-drone-mysql:
        condition: service_healthy
      aiot-redis:
        condition: service_started
      aiot-rabbitmq:
        condition: service_healthy
      scheduler-service:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      # 檢查 Archive Processor 微服務的 HTTP API 端點健康狀態
      # 確保歸檔處理服務正常運行，可以處理 RabbitMQ 歸檔任務
      test: ["CMD", "curl", "-f", "http://localhost:3005/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Gateway API 服務 (Express.js API Gateway)
  gateway-service:
    build:
      context: ../../microServices/gateway-service
      dockerfile: Dockerfile.dev
    logging: *default-logging
    container_name: aiot-gateway-service
    ports:
      - "8000:8000"   # Gateway HTTP API endpoint
    environment:
      <<: *common-env
      SERVICE_NAME: gateway-service
      PORT: 8000
      GATEWAY_PORT: 8000
      NODE_ENV: development
      # Gateway 不需要資料庫配置，但需要微服務端點配置
      # 微服務端點配置 (使用 Docker 服務名稱)
      RBAC_SERVICE_HOST: aiot-rbac-service
      RBAC_SERVICE_PORT: 50051
      RBAC_HTTP_PORT: 3051
      DRONE_SERVICE_HOST: aiot-drone-service  
      DRONE_SERVICE_PORT: 50052
      DRONE_HTTP_PORT: 3052
      GENERAL_SERVICE_HOST: aiot-general-service
      GENERAL_SERVICE_PORT: 50053
      GENERAL_HTTP_PORT: 3053
      DOCS_SERVICE_HOST: aiot-docs-service
      DOCS_SERVICE_PORT: 3054
      DRONE_WEBSOCKET_SERVICE_HOST: aiot-drone-websocket-service
      DRONE_WEBSOCKET_SERVICE_PORT: 3004
    volumes:
      - ../../microServices/gateway-service:/app
      - /app/node_modules
    networks:
      - aiot-network
    depends_on:
      consul:
        condition: service_healthy
      aiot-redis:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      # 檢查 Gateway 服務的健康狀態
      # 確保 API 網關正常運行，可以接收和轉發前端請求到對應的微服務
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================================================
  # 前端應用 (Frontend Application)
  # ==========================================================================

  # 前端 React 應用
  frontend-app:
    build:
      context: ../../frontend
      dockerfile: Dockerfile.fe
    logging: *default-logging
    container_name: aiot-frontend
    ports:
      - "3000:3000"   # Vite 開發服務器
    environment:
      # 前端專用環境變數（不繼承微服務配置）
      NODE_ENV: development
      # 其他環境變數使用 .env 文件中的設定，避免衝突
    volumes:
      - ../../frontend:/app/fe
      - /app/fe/node_modules
      # 快取 node_modules 以提升效能
    networks:
      - aiot-network
    # 前端不依賴後端服務，獨立啟動
    restart: unless-stopped
    healthcheck:
      # 檢查前端 React 應用的健康狀態
      # 確保 Vite 開發服務器正常運行，前端頁面可以正常訪問和載入
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s  # Vite 需要較長啟動時間

  # ==========================================================================
  # 監控服務 (Monitoring Services) - 可選
  # ==========================================================================

  # Prometheus 監控
  prometheus:
    image: prom/prometheus:v2.45.0
    logging: *default-logging
    container_name: aiot-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ../monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    networks:
      - aiot-network
    restart: unless-stopped
    profiles:
      - monitoring

  # Grafana 儀表板
  grafana:
    image: grafana/grafana:10.0.0
    logging: *default-logging
    container_name: aiot-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - aiot-network
    depends_on:
      - prometheus
    restart: unless-stopped
    profiles:
      - monitoring

# ==========================================================================
# 資料持久化 (Persistent Volumes)
# ==========================================================================
volumes:
  # 各微服務專用 MySQL 資料持久化
  mysql_rbac_data:
    driver: local
    name: aiot_mysql_rbac_data
  mysql_drone_data:
    driver: local
    name: aiot_mysql_drone_data
  mysql_general_data:
    driver: local
    name: aiot_mysql_general_data
  mysql_shared_data:
    driver: local
    name: aiot_mysql_shared_data
  mongodb_data:
    driver: local
  redis_data:
    driver: local
  rabbitmq_data:
    driver: local
  consul_data:
    driver: local
  # 新增微服務日誌持久化
  scheduler_logs:
    driver: local
    name: aiot_scheduler_logs
  archive_processor_logs:
    driver: local
    name: aiot_archive_processor_logs
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

# ==========================================================================
# 網路配置 (Network Configuration)
# ==========================================================================
networks:
  aiot-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16