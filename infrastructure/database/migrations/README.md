# AIOT Database Migration ç³»çµ±

## ğŸ“‹ æ¦‚è¦½

æœ¬ç³»çµ±ä½¿ç”¨ Sequelize CLI å¯¦ç¾è³‡æ–™åº«ç‰ˆæœ¬æ§åˆ¶å’Œé·ç§»ç®¡ç†ï¼Œç‚º AIOT å¾®æœå‹™æ¶æ§‹æä¾›ä¸€è‡´çš„è³‡æ–™åº«schemaç®¡ç†ã€‚

## ğŸ—ï¸ æ¶æ§‹è¨­è¨ˆ

### æœå‹™åˆ†é›¢ç­–ç•¥

æ¯å€‹å¾®æœå‹™ç¶­è­·è‡ªå·±çš„é·ç§»æ–‡ä»¶ï¼Œç¢ºä¿ç¨ç«‹éƒ¨ç½²å’Œç‰ˆæœ¬ç®¡ç†ï¼š

```
migrations/
â”œâ”€â”€ rbac-service/          # RBAC æ¬Šé™ç®¡ç†
â”œâ”€â”€ drone-service/         # ç„¡äººæ©Ÿæ•¸æ“šç®¡ç†
â”œâ”€â”€ general-service/       # ç”¨æˆ¶åå¥½è¨­å®š
â”œâ”€â”€ auth-service/          # èªè­‰æœå‹™
â”œâ”€â”€ drone-websocket/       # WebSocket å³æ™‚æœå‹™
â””â”€â”€ shared/               # å…±äº«å·¥å…·å’Œé…ç½®
```

### è³‡æ–™åº«å°æ‡‰é—œä¿‚

| å¾®æœå‹™ | è³‡æ–™åº« | ç«¯å£ | ä¸»è¦åŠŸèƒ½ |
|--------|--------|------|----------|
| **RBAC Service** | main_db | 5432 | ç”¨æˆ¶ã€è§’è‰²ã€æ¬Šé™ç®¡ç† |
| **Auth Service** | main_db | 5432 | èªè­‰ã€æœƒè©±ç®¡ç† |
| **Drone Service** | drone_db | 5433 | ç„¡äººæ©Ÿç‹€æ…‹ã€ä½ç½®ã€æŒ‡ä»¤ |
| **Drone WebSocket** | drone_db | 5434 | å³æ™‚æ•¸æ“šæ¨é€ |
| **General Service** | user_preference_db | 5435 | ç”¨æˆ¶åå¥½ã€ç³»çµ±è¨­å®š |

## ğŸš€ ä½¿ç”¨æ–¹å¼

### 1. å‰µå»ºæ–°é·ç§»

```bash
# RBAC Service é·ç§»
cd infrastructure/database/migrations/rbac-service
npx sequelize-cli migration:generate --name add-user-avatar-field

# Drone Service é·ç§»
cd infrastructure/database/migrations/drone-service
npx sequelize-cli migration:generate --name create-drone-battery-table
```

### 2. åŸ·è¡Œé·ç§»

```bash
# åŸ·è¡Œå–®ä¸€æœå‹™é·ç§»
./migrate.sh rbac-service up

# åŸ·è¡Œæ‰€æœ‰æœå‹™é·ç§»
./migrate-all.sh up

# å›æ»¾é·ç§»
./migrate.sh drone-service down
```

### 3. æª¢æŸ¥é·ç§»ç‹€æ…‹

```bash
# æª¢æŸ¥é·ç§»ç‹€æ…‹
./status.sh rbac-service

# æª¢æŸ¥æ‰€æœ‰æœå‹™ç‹€æ…‹
./status-all.sh
```

## ğŸ“ æ–‡ä»¶çµæ§‹

### é·ç§»æ–‡ä»¶å‘½åè¦ç¯„

```
YYYYMMDDHHMMSS-descriptive-name.js
ä¾‹å¦‚ï¼š20250824120000-create-users-table.js
```

### é…ç½®æ–‡ä»¶çµæ§‹

```javascript
module.exports = {
  development: {
    database: 'main_db',
    host: process.env.DB_HOST || 'localhost',
    port: process.env.DB_PORT || 5432,
    dialect: 'postgres'
  },
  production: {
    // ç”Ÿç”¢ç’°å¢ƒé…ç½®
  }
}
```

## ğŸ”§ æœ€ä½³å¯¦è¸

### 1. é·ç§»æ–‡ä»¶ç·¨å¯«åŸå‰‡

- **å‘å‰ç›¸å®¹**ï¼šç¢ºä¿æ–°é·ç§»ä¸æœƒç ´å£æ—¢æœ‰åŠŸèƒ½
- **åŸå­æ€§æ“ä½œ**ï¼šæ¯å€‹é·ç§»æ‡‰è©²æ˜¯å®Œæ•´çš„å–®å…ƒ
- **å¯å›æ»¾**ï¼šæä¾›å®Œæ•´çš„ `down` æ–¹æ³•
- **æ¸¬è©¦é©—è­‰**ï¼šåœ¨é–‹ç™¼ç’°å¢ƒå……åˆ†æ¸¬è©¦

### 2. Schema è®Šæ›´æŒ‡å°

- **æ·»åŠ æ¬„ä½**ï¼šä½¿ç”¨ `DEFAULT` å€¼æˆ– `NULL` å…è¨±
- **åˆªé™¤æ¬„ä½**ï¼šåˆ†éšæ®µé€²è¡Œï¼ˆdeprecated â†’ ç§»é™¤ï¼‰
- **é‡å‘½åæ¬„ä½**ï¼šä½¿ç”¨é·ç§»è€Œéç›´æ¥é‡å‘½å
- **ç´¢å¼•ç®¡ç†**ï¼šèˆ‡ç›¸é—œæ¬„ä½åŒæ­¥å‰µå»º

### 3. æ•¸æ“šé·ç§»ç­–ç•¥

- **å¤§é‡æ•¸æ“š**ï¼šåˆ†æ‰¹è™•ç†é¿å…é–è¡¨
- **é—œéµæ•¸æ“š**ï¼šæä¾›å‚™ä»½å’Œé©—è­‰æ©Ÿåˆ¶
- **æ™‚é–“çª—å£**ï¼šé¸æ“‡ä½å³°æ™‚æ®µåŸ·è¡Œ

## âš ï¸ æ³¨æ„äº‹é …

### 1. ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²

- **å‚™ä»½å„ªå…ˆ**ï¼šåŸ·è¡Œå‰å®Œæ•´å‚™ä»½è³‡æ–™åº«
- **æ¸¬è©¦é©—è­‰**ï¼šåœ¨ç›¸åŒæ•¸æ“šçš„æ¸¬è©¦ç’°å¢ƒé©—è­‰
- **ç›£æ§è¨ˆç•«**ï¼šæº–å‚™å›æ»¾è¨ˆç•«å’Œç›£æ§æŒ‡æ¨™
- **åˆ†éšæ®µéƒ¨ç½²**ï¼šé€æ­¥éƒ¨ç½²é¿å…å…¨é¢å½±éŸ¿

### 2. é–‹ç™¼ç’°å¢ƒç®¡ç†

- **ä¿æŒåŒæ­¥**ï¼šå®šæœŸåŒæ­¥æœ€æ–°é·ç§»
- **æ¸…ç†æ¸¬è©¦**ï¼šå®šæœŸé‡ç½®é–‹ç™¼è³‡æ–™åº«
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šé·ç§»æ–‡ä»¶ç´å…¥ç‰ˆæœ¬æ§åˆ¶

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

1. **é·ç§»å¤±æ•—**
   ```bash
   # æª¢æŸ¥è³‡æ–™åº«é€£æ¥
   ./check-connection.sh rbac-service
   
   # æŸ¥çœ‹è©³ç´°éŒ¯èª¤
   ./migrate.sh rbac-service up --verbose
   ```

2. **ç‰ˆæœ¬è¡çª**
   ```bash
   # æª¢æŸ¥ç•¶å‰ç‰ˆæœ¬
   ./status.sh rbac-service
   
   # æ‰‹å‹•ä¿®å¾©ç‰ˆæœ¬è¡¨
   ./repair-version.sh rbac-service
   ```

3. **å›æ»¾å•é¡Œ**
   ```bash
   # å¼·åˆ¶é‡ç½®åˆ°ç‰¹å®šç‰ˆæœ¬
   ./reset-to-version.sh rbac-service 20250824120000
   ```

## ğŸ“Š ç›£æ§å’Œæ—¥èªŒ

### é·ç§»æ—¥èªŒ

æ‰€æœ‰é·ç§»æ“ä½œéƒ½æœƒè¨˜éŒ„åˆ°ï¼š
- `logs/migrations/[service]-[timestamp].log`
- è³‡æ–™åº« `SequelizeMeta` è¡¨
- Docker å®¹å™¨æ—¥èªŒ

### æ€§èƒ½ç›£æ§

- é·ç§»åŸ·è¡Œæ™‚é–“è¿½è¹¤
- è³‡æ–™åº«é€£æ¥æ± ç‹€æ…‹
- ç£ç¢Ÿç©ºé–“ä½¿ç”¨ç›£æ§

---

*æœ€å¾Œæ›´æ–°ï¼š2025-08-24*  
*ç‰ˆæœ¬ï¼šv1.0*  
*ç¶­è­·è€…ï¼šAIOT Development Team*