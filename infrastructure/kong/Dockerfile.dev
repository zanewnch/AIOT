# AIOT Kong Gateway - Development Dockerfile
# ⚙️ 開發環境專用，支援 gRPC Gateway + HTTP + Admin API

FROM kong:3.4 as development

# 安裝系統依賴和除錯工具
USER root
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    netcat \
    dnsutils \
    jq \
    && rm -rf /var/lib/apt/lists/*

# 安裝 Kong OPA 插件依賴 - 跳過 luarocks，使用手動方式
# RUN luarocks install lua-resty-http

# 下載 lua-resty-http 手動安裝
RUN wget -O /tmp/lua-resty-http.tar.gz https://github.com/ledgetech/lua-resty-http/archive/master.tar.gz && \
    cd /tmp && tar -xzf lua-resty-http.tar.gz && \
    mkdir -p /usr/local/share/lua/5.1/resty && \
    cp lua-resty-http-master/lib/resty/http.lua /usr/local/share/lua/5.1/resty/ && \
    rm -rf /tmp/lua-resty-http*

# 下載 lua-resty-jwt 手動安裝
RUN wget -O /tmp/lua-resty-jwt.tar.gz https://github.com/SkyLothar/lua-resty-jwt/archive/master.tar.gz && \
    cd /tmp && tar -xzf lua-resty-jwt.tar.gz && \
    cp -r lua-resty-jwt-master/lib/resty/* /usr/local/share/lua/5.1/resty/ && \
    rm -rf /tmp/lua-resty-jwt*

# 下載 lua-resty-hmac 手動安裝
RUN wget -O /tmp/lua-resty-hmac.tar.gz https://github.com/jkeys089/lua-resty-hmac/archive/master.tar.gz && \
    cd /tmp && tar -xzf lua-resty-hmac.tar.gz && \
    cp lua-resty-hmac-master/lib/resty/hmac.lua /usr/local/share/lua/5.1/resty/ && \
    rm -rf /tmp/lua-resty-hmac*

# 下載並安裝 wada-ama Kong OPA 插件
RUN wget -O /tmp/kong-plugin-opa.tar.gz https://github.com/wada-ama/kong-plugin-opa/archive/master.tar.gz && \
    cd /tmp && tar -xzf kong-plugin-opa.tar.gz && \
    mkdir -p /usr/local/share/lua/5.1/kong/plugins/opa && \
    cp -r kong-plugin-opa-master/src/kong/plugins/opa/* /usr/local/share/lua/5.1/kong/plugins/opa/ && \
    rm -rf /tmp/kong-plugin-opa*

# 創建必要目錄並設置權限
RUN mkdir -p /usr/local/kong/logs /usr/local/kong/ssl && \
    chown -R kong:kong /usr/local/kong && \
    chown -R kong:kong /usr/local/share/lua/5.1/kong/plugins/opa

# 切換回 kong 用戶
USER kong

# 開發端口 (Proxy + Admin API + gRPC)
EXPOSE 8000 8001 8443 8444

# 健康檢查 - 檢查 Admin API
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
  CMD curl -f http://localhost:8001/status || exit 1

# 開發環境啟動命令
ENTRYPOINT ["/docker-entrypoint.sh"]
CMD ["kong", "docker-start"]