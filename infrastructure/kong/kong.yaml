# ==============================================
# Kong Gateway è²æ˜å¼é…ç½® - AIOT å¾®æœå‹™æ¶æ§‹
# ==============================================
# 
# é…ç½®èªªæ˜ï¼š
# â€¢ æ­¤æ–‡ä»¶æ•´åˆäº†æ‰€æœ‰ Kong Gateway é…ç½®
# â€¢ æ”¯æ´ AIOT å¾®æœå‹™æ¶æ§‹çš„ API Gateway éœ€æ±‚
# â€¢ åŒ…å«æœå‹™ç™¼ç¾ã€è·¯ç”±ã€æ’ä»¶ç­‰å®Œæ•´é…ç½®
# 
# æ¶æ§‹æ¦‚è¦½ï¼š
# Kong Gateway â†’ å„å¾®æœå‹™
# â€¢ /api/auth â†’ RBAC æœå‹™ (gRPC)
# â€¢ /api/rbac â†’ RBAC æœå‹™ (gRPC) 
# â€¢ /api/drone â†’ Drone æœå‹™ (gRPC)
# â€¢ /socket.io â†’ Drone WebSocket æœå‹™ (HTTP + WebSocket å‡ç´š)
# â€¢ /api/general â†’ General æœå‹™ (gRPC)
# â€¢ /api/llm â†’ LLM æœå‹™ (gRPC)
# â€¢ /docs â†’ æ–‡æª”æœå‹™ (HTTP)
# â€¢ / â†’ é‡å®šå‘åˆ°æ–‡æª”æœå‹™
#
# ç¶²è·¯é…ç½®ï¼š
# â€¢ ä½¿ç”¨ Docker Compose æœå‹™åç¨±é€²è¡Œå…§éƒ¨é€šè¨Š
# â€¢ æ‰€æœ‰æœå‹™éƒ½åœ¨ aiot-network ç¶²è·¯ä¸­
# â€¢ Kong é€é Docker å…§å»º DNS è§£ææœå‹™åç¨±

_format_version: "3.0"

# ==============================================
# ğŸ”§ æœå‹™å®šç¾© (Services)
# ==============================================

services:
  # ğŸ” RBAC å¾®æœå‹™ - ä½¿ç”¨ HTTP å”è­°é€²è¡Œå…§éƒ¨é€šè¨Š
  - name: rbac-service
    protocol: http
    host: rbac-service
    port: 3001
    connect_timeout: 5000
    write_timeout: 10000
    read_timeout: 10000
    retries: 2
    tags:
      - auth
      - rbac
      - microservice
      - http

  # ğŸš Drone API å¾®æœå‹™ - ä½¿ç”¨ gRPC å”è­°è™•ç† API è«‹æ±‚
  - name: drone-grpc-service
    protocol: grpc
    host: drone-service
    port: 50052
    connect_timeout: 5000
    write_timeout: 10000
    read_timeout: 10000
    retries: 2
    tags:
      - drone
      - api
      - grpc

  # ğŸ“¡ Drone WebSocket å¾®æœå‹™ - å°ˆé–€è™•ç† WebSocket é€£ç·šï¼ˆé€é HTTP å‡ç´šæ©Ÿåˆ¶ï¼‰
  - name: drone-websocket-service
    protocol: http
    host: drone-websocket-service
    port: 3004
    connect_timeout: 5000
    write_timeout: 10000
    read_timeout: 10000
    retries: 2
    tags:
      - drone
      - websocket
      - realtime

  # âš™ï¸ General å¾®æœå‹™ - ä½¿ç”¨ gRPC å”è­°
  - name: general-service
    protocol: grpc
    host: general-service
    port: 50053
    connect_timeout: 5000
    write_timeout: 10000
    read_timeout: 10000
    retries: 2
    tags:
      - general
      - documentation
      - grpc

  # ğŸ“š æ–‡æª”æœå‹™ - çµ±ä¸€ç®¡ç†æ‰€æœ‰å¾®æœå‹™çš„ TypeDoc æ–‡æª”
  - name: docs-service
    protocol: http
    host: docs-upstream
    connect_timeout: 5000
    write_timeout: 10000
    read_timeout: 10000
    retries: 2
    tags:
      - documentation
      - typedoc
      - static
      - http

  # ğŸ¤– LLM å¾®æœå‹™ - ä½¿ç”¨ HTTP å”è­°æä¾› AI/LLM åŠŸèƒ½ (Django)
  - name: llm-service
    protocol: http
    host: llm-service
    port: 8020
    connect_timeout: 5000
    write_timeout: 10000
    read_timeout: 10000
    retries: 2
    tags:
      - llm
      - ai
      - microservice
      - django
      - http

# ==============================================
# ğŸ›£ï¸ è·¯ç”±å®šç¾© (Routes)
# ==============================================

routes:
  # ğŸ” RBAC èªè­‰è·¯ç”± - æ”¯æ´ HTTP/HTTPS
  - name: rbac-auth-routes
    service: rbac-service
    paths:
      - /api/auth
    strip_path: true  # ç§»é™¤è·¯å¾‘å‰ç¶´ï¼Œè½‰ç™¼ä¹¾æ·¨è·¯å¾‘çµ¦å¾®æœå‹™
    preserve_host: false
    protocols:
      - http
      - https
    tags:
      - auth
      - login
      - gateway-only

  # ğŸ” RBAC ç®¡ç†è·¯ç”± - æ”¯æ´ HTTP/HTTPS
  - name: rbac-routes
    service: rbac-service
    paths:
      - /api/rbac
    strip_path: true   # ç§»é™¤ /api/rbac å‰ç¶´
    preserve_host: false
    protocols:
      - http
      - https
    tags:
      - rbac
      - permissions
      - gateway-only

  # ğŸ” RBAC ç›´æ¥è·¯ç”± - æ”¯æ´ /rbac/ è·¯å¾‘
  - name: rbac-direct-routes
    service: rbac-service
    paths:
      - /rbac
    strip_path: true   # ç§»é™¤ /rbac å‰ç¶´
    preserve_host: false
    protocols:
      - http
      - https
    tags:
      - rbac
      - direct
      - gateway-only

  # ğŸš Drone API è·¯ç”± - æ”¯æ´ HTTP/HTTPSï¼Œé€£æ¥åˆ° gRPC æœå‹™
  - name: drone-api-routes
    service: drone-grpc-service
    paths:
      - /api/drone
    strip_path: true   # ç§»é™¤ /api/drone å‰ç¶´
    preserve_host: false
    protocols:
      - http
      - https
    tags:
      - drone
      - api
      - gateway-only
      - grpc

  # ğŸ“¡ Drone WebSocket è·¯ç”± - æ”¯æ´ HTTP/HTTPSï¼ˆWebSocket é€šé HTTP å‡ç´šæ©Ÿåˆ¶ï¼‰
  - name: drone-websocket-routes
    service: drone-websocket-service
    paths:
      - /socket.io
    strip_path: false   # ä¿æŒ /socket.io è·¯å¾‘ï¼ŒWebSocket éœ€è¦å®Œæ•´è·¯å¾‘
    preserve_host: false
    protocols:
      - http
      - https
    tags:
      - drone
      - websocket
      - realtime
      - gateway-only

  # âš™ï¸ General æ–‡æª”è·¯ç”± - æ”¯æ´ HTTP/HTTPS
  - name: general-docs-routes
    service: general-service
    paths:
      - /api/docs
    strip_path: true   # ç§»é™¤ /api/docs å‰ç¶´ï¼Œè½‰ç™¼ / çµ¦å¾®æœå‹™
    preserve_host: false
    protocols:
      - http
      - https
    tags:
      - general
      - documentation
      - gateway-only
      
  # âš™ï¸ General API è·¯ç”± - æ”¯æ´ HTTP/HTTPS  
  - name: general-api-routes
    service: general-service
    paths:
      - /api/general
    strip_path: true   # ç§»é™¤ /api/general å‰ç¶´ï¼Œè½‰ç™¼ / çµ¦å¾®æœå‹™
    preserve_host: false
    protocols:
      - http
      - https
    tags:
      - general
      - documentation
      - gateway-only

  # ğŸ’Š å¥åº·æª¢æŸ¥è·¯ç”± - å…§éƒ¨ä½¿ç”¨ï¼Œåƒ… HTTP
  - name: health-check-routes
    service: general-service
    paths:
      - /health
    strip_path: true   # ç§»é™¤ /health å‰ç¶´
    preserve_host: false
    protocols:
      - http
    tags:
      - health
      - internal

  # ğŸ“š æ–‡æª”æœå‹™è·¯ç”± - çµ±ä¸€çš„ TypeDoc æ–‡æª”å…¥å£
  - name: docs-service-routes
    service: docs-service
    paths:
      - /docs
    strip_path: true   # ç§»é™¤ /docs å‰ç¶´ï¼Œè½‰ç™¼ä¹¾æ·¨è·¯å¾‘çµ¦æ–‡æª”æœå‹™
    preserve_host: false
    protocols:
      - http
      - https
    tags:
      - documentation
      - typedoc
      - static
      - gateway-only

  # ğŸ¤– LLM API è·¯ç”± - æ”¯æ´ HTTP/HTTPSï¼Œé€£æ¥åˆ° Django æœå‹™
  - name: llm-api-routes
    service: llm-service
    paths:
      - /api/llm
    strip_path: true   # ç§»é™¤ /api/llm å‰ç¶´ï¼Œè½‰ç™¼ /api/ çµ¦ Django
    preserve_host: false
    protocols:
      - http
      - https
    tags:
      - llm
      - ai
      - api
      - gateway-only
      - django

  # ğŸ  æ ¹è·¯å¾‘è·¯ç”± - é‡å®šå‘åˆ°æ–‡æª”é é¢
  - name: root-route
    service: docs-service
    paths:
      - /
    strip_path: false  # ä¿æŒæ ¹è·¯å¾‘
    preserve_host: false
    protocols:
      - http
      - https
    tags:
      - root
      - documentation

# ==============================================
# ğŸ”Œ æ’ä»¶é…ç½® (Plugins)
# ==============================================
# 
# æ€§èƒ½å„ªåŒ–æ’ä»¶é…ç½®

plugins:
  # ğŸ“š æ–‡æª”æœå‹™ä»£ç†ç·©å­˜ - ç·©å­˜éœæ…‹å…§å®¹
  - name: proxy-cache
    service: docs-service
    config:
      request_method: ["GET", "HEAD"]
      response_code: [200, 301, 302, 404]
      content_type: ["text/html", "text/css", "application/javascript", "text/javascript", "image/png", "image/jpg", "image/jpeg", "image/gif", "image/svg+xml"]
      cache_ttl: 3600
      strategy: memory
      memory:
        dictionary_name: "kong_db_cache"
    tags:
      - caching
      - performance
      - docs

# ==============================================
# ğŸ¯ ä¸Šæ¸¸æœå‹™é…ç½® (Upstreams)
# ==============================================
# 
# é…ç½®è² è¼‰å¹³è¡¡å™¨å’Œå¥åº·æª¢æŸ¥

upstreams:
  # ğŸ“š æ–‡æª”æœå‹™ä¸Šæ¸¸é…ç½®
  - name: docs-upstream
    algorithm: round-robin
    hash_on: none
    hash_fallback: none
    hash_on_header: null
    hash_fallback_header: null
    hash_on_cookie: null
    hash_on_query_arg: null
    slots: 10000
    healthchecks:
      passive:
        type: http
        healthy:
          http_statuses: [200, 302]
          successes: 3
        unhealthy:
          http_statuses: [429, 500, 503, 504]
          tcp_failures: 3
          timeouts: 3
          http_failures: 3
      active:
        type: http
        timeout: 2
        concurrency: 1
        http_path: "/health"
        https_verify_certificate: false
        healthy:
          interval: 30
          http_statuses: [200]
          successes: 1
        unhealthy:
          interval: 10
          http_statuses: [429, 500, 502, 503, 504]
          tcp_failures: 1
          timeouts: 1
          http_failures: 3
    targets:
      - target: docs-service:3005
        weight: 100
    tags:
      - docs
      - upstream

# ==============================================
# ğŸ‘¤ æ¶ˆè²»è€…é…ç½® (Consumers)  
# ==============================================
#
# ç›®å‰ä¸éœ€è¦èªè­‰æ¶ˆè²»è€…
# å¦‚éœ€ API Key æˆ– JWT èªè­‰ï¼Œåœ¨æ­¤è™•é…ç½®

consumers: []