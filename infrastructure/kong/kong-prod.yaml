# ==============================================
# Kong Gateway è²æ˜å¼é…ç½® - AIOT ç”Ÿç”¢ç’°å¢ƒ
# ==============================================
# 
# â˜¸ï¸ Production Environment Only
# â€¢ ä½¿ç”¨ Kubernetes æœå‹™ç™¼ç¾
# â€¢ ç”Ÿç”¢ç´šæ€§èƒ½å„ªåŒ–
# â€¢ é«˜å¯ç”¨é…ç½®
# 
# æ¶æ§‹æ¦‚è¦½ï¼š
# Kong Gateway â†’ Kubernetes Services
# â€¢ /api/auth â†’ RBAC æœå‹™ (HTTP + gRPC)
# â€¢ /api/rbac â†’ RBAC æœå‹™ (HTTP + gRPC) 
# â€¢ /api/drone â†’ Drone æœå‹™ (HTTP + gRPC)
# â€¢ /socket.io â†’ Drone WebSocket æœå‹™ (WebSocket)
# â€¢ /api/general â†’ General æœå‹™ (HTTP + gRPC)
# â€¢ /api/llm â†’ LLM æœå‹™ (HTTP - Django)
# â€¢ /docs â†’ æ–‡æª”æœå‹™ (HTTP)
# â€¢ / â†’ é‡å®šå‘åˆ°æ–‡æª”æœå‹™
#
# ç¶²è·¯é…ç½®ï¼š
# â€¢ ä½¿ç”¨ Kubernetes æœå‹™åç¨±é€²è¡Œå…§éƒ¨é€šè¨Š
# â€¢ æ‰€æœ‰æœå‹™éƒ½åœ¨ aiot-prod å‘½åç©ºé–“ä¸­
# â€¢ Kong é€é Kubernetes DNS è§£ææœå‹™åç¨±

_format_version: "3.0"

# ==============================================
# ğŸ”§ æœå‹™å®šç¾© (Services) - Production
# ==============================================

services:
  # ğŸ” RBAC å¾®æœå‹™ - ç”Ÿç”¢ç’°å¢ƒä½¿ç”¨ Kubernetes æœå‹™åç¨±
  - name: rbac-service
    protocol: http
    host: rbac-service.aiot-prod.svc.cluster.local
    port: 3001
    connect_timeout: 5000
    write_timeout: 10000
    read_timeout: 10000
    retries: 2
    tags:
      - auth
      - rbac
      - microservice
      - http
      - production

  # ğŸš Drone API å¾®æœå‹™ - ç”Ÿç”¢ç’°å¢ƒ gRPC æœå‹™
  - name: drone-grpc-service
    protocol: grpc
    host: drone-service.aiot-prod.svc.cluster.local
    port: 50052
    connect_timeout: 5000
    write_timeout: 10000
    read_timeout: 10000
    retries: 2
    tags:
      - drone
      - api
      - grpc
      - production

  # ğŸ“¡ Drone WebSocket å¾®æœå‹™ - ç”Ÿç”¢ç’°å¢ƒ WebSocket æœå‹™
  - name: drone-websocket-service
    protocol: http
    host: drone-websocket-service.aiot-prod.svc.cluster.local
    port: 3004
    connect_timeout: 5000
    write_timeout: 10000
    read_timeout: 10000
    retries: 2
    tags:
      - drone
      - websocket
      - realtime
      - production

  # âš™ï¸ General å¾®æœå‹™ - ç”Ÿç”¢ç’°å¢ƒ gRPC æœå‹™
  - name: general-service
    protocol: grpc
    host: general-service.aiot-prod.svc.cluster.local
    port: 50053
    connect_timeout: 5000
    write_timeout: 10000
    read_timeout: 10000
    retries: 2
    tags:
      - general
      - documentation
      - grpc
      - production

  # ğŸ“š æ–‡æª”æœå‹™ - ç”Ÿç”¢ç’°å¢ƒä½¿ç”¨ upstream è² è¼‰å¹³è¡¡
  - name: docs-service
    protocol: http
    host: docs-upstream-prod
    connect_timeout: 3000
    write_timeout: 8000
    read_timeout: 8000
    retries: 2
    tags:
      - documentation
      - typedoc
      - static
      - http
      - production

  # ğŸ¤– LLM å¾®æœå‹™ - ç”Ÿç”¢ç’°å¢ƒ Django æœå‹™
  - name: llm-service
    protocol: http
    host: llm-service.aiot-prod.svc.cluster.local
    port: 8020
    connect_timeout: 10000
    write_timeout: 30000
    read_timeout: 30000
    retries: 2
    tags:
      - llm
      - ai
      - microservice
      - django
      - http
      - production

# ==============================================
# ğŸ›£ï¸ è·¯ç”±å®šç¾© (Routes) - Production
# ==============================================

routes:
  # ğŸ” RBAC èªè­‰è·¯ç”± - ç”Ÿç”¢ç’°å¢ƒ
  - name: rbac-auth-routes
    service: rbac-service
    paths:
      - /api/auth
    strip_path: true
    preserve_host: false
    protocols:
      - http
      - https
    https_redirect_status_code: 301
    tags:
      - auth
      - login
      - gateway-only
      - production

  # ğŸ” RBAC ç®¡ç†è·¯ç”± - ç”Ÿç”¢ç’°å¢ƒ
  - name: rbac-routes
    service: rbac-service
    paths:
      - /api/rbac
    strip_path: true
    preserve_host: false
    protocols:
      - http
      - https
    https_redirect_status_code: 301
    tags:
      - rbac
      - permissions
      - gateway-only
      - production

  # ğŸ” RBAC ç›´æ¥è·¯ç”± - ç”Ÿç”¢ç’°å¢ƒ
  - name: rbac-direct-routes
    service: rbac-service
    paths:
      - /rbac
    strip_path: true
    preserve_host: false
    protocols:
      - http
      - https
    https_redirect_status_code: 301
    tags:
      - rbac
      - direct
      - gateway-only
      - production

  # ğŸš Drone API è·¯ç”± - ç”Ÿç”¢ç’°å¢ƒ gRPC
  - name: drone-api-routes
    service: drone-grpc-service
    paths:
      - /api/drone
    strip_path: true
    preserve_host: false
    protocols:
      - http
      - https
    https_redirect_status_code: 301
    tags:
      - drone
      - api
      - gateway-only
      - grpc
      - production

  # ğŸ“¡ Drone WebSocket è·¯ç”± - ç”Ÿç”¢ç’°å¢ƒ
  - name: drone-websocket-routes
    service: drone-websocket-service
    paths:
      - /socket.io
    strip_path: false
    preserve_host: false
    protocols:
      - http
      - https
    tags:
      - drone
      - websocket
      - realtime
      - gateway-only
      - production

  # âš™ï¸ General API è·¯ç”± - ç”Ÿç”¢ç’°å¢ƒ gRPC
  - name: general-api-routes
    service: general-service
    paths:
      - /api/general
    strip_path: true
    preserve_host: false
    protocols:
      - http
      - https
    https_redirect_status_code: 301
    tags:
      - general
      - documentation
      - gateway-only
      - production

  # ğŸ’Š å¥åº·æª¢æŸ¥è·¯ç”± - ç”Ÿç”¢ç’°å¢ƒå…§éƒ¨ä½¿ç”¨
  - name: health-check-routes
    service: general-service
    paths:
      - /health
    strip_path: true
    preserve_host: false
    protocols:
      - http
    tags:
      - health
      - internal
      - production

  # ğŸ“š æ–‡æª”æœå‹™è·¯ç”± - ç”Ÿç”¢ç’°å¢ƒ
  - name: docs-service-routes
    service: docs-service
    paths:
      - /docs
    strip_path: true
    preserve_host: false
    protocols:
      - http
      - https
    https_redirect_status_code: 301
    tags:
      - documentation
      - typedoc
      - static
      - gateway-only
      - production

  # ğŸ¤– LLM API è·¯ç”± - ç”Ÿç”¢ç’°å¢ƒ Django
  - name: llm-api-routes
    service: llm-service
    paths:
      - /api/llm
    strip_path: true
    preserve_host: false
    protocols:
      - http
      - https
    https_redirect_status_code: 301
    tags:
      - llm
      - ai
      - api
      - gateway-only
      - django
      - production

  # ğŸ  æ ¹è·¯å¾‘è·¯ç”± - ç”Ÿç”¢ç’°å¢ƒé‡å®šå‘
  - name: root-route
    service: docs-service
    paths:
      - /
    strip_path: false
    preserve_host: false
    protocols:
      - http
      - https
    https_redirect_status_code: 301
    tags:
      - root
      - documentation
      - production

# ==============================================
# ğŸ”Œ æ’ä»¶é…ç½® (Plugins) - Production
# ==============================================

plugins:
  # ğŸ“š æ–‡æª”æœå‹™ä»£ç†ç·©å­˜ - ç”Ÿç”¢ç’°å¢ƒå„ªåŒ–
  - name: proxy-cache
    service: docs-service
    config:
      request_method: ["GET", "HEAD"]
      response_code: [200, 301, 302, 404]
      content_type: ["text/html", "text/css", "application/javascript", "text/javascript", "image/png", "image/jpg", "image/jpeg", "image/gif", "image/svg+xml"]
      cache_ttl: 7200  # ç”Ÿç”¢ç’°å¢ƒè¼ƒé•·å¿«å–æ™‚é–“
      strategy: memory
      memory:
        dictionary_name: "kong_db_cache"
    tags:
      - caching
      - performance
      - docs
      - production

  # ğŸ›¡ï¸ é€Ÿç‡é™åˆ¶æ’ä»¶ - ç”Ÿç”¢ç’°å¢ƒå®‰å…¨
  - name: rate-limiting
    config:
      minute: 100
      hour: 1000
      policy: local
      hide_client_headers: true
    tags:
      - security
      - rate-limiting
      - production

  # ğŸ“Š Prometheus ç›£æ§æ’ä»¶ - ç”Ÿç”¢ç’°å¢ƒç›£æ§
  - name: prometheus
    config:
      per_consumer: true
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true
    tags:
      - monitoring
      - metrics
      - production

  # ğŸ” CORS æ’ä»¶ - ç”Ÿç”¢ç’°å¢ƒè·¨åŸŸé…ç½®
  - name: cors
    config:
      origins: ["https://aiot.production.domain.com"]
      methods: ["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"]
      headers: ["Accept", "Accept-Version", "Content-Length", "Content-MD5", "Content-Type", "Date", "X-Auth-Token", "Authorization"]
      exposed_headers: ["X-Auth-Token"]
      credentials: true
      max_age: 3600
      preflight_continue: false
    tags:
      - security
      - cors
      - production

# ==============================================
# ğŸ¯ ä¸Šæ¸¸æœå‹™é…ç½® (Upstreams) - Production
# ==============================================

upstreams:
  # ğŸ“š æ–‡æª”æœå‹™ä¸Šæ¸¸é…ç½® - ç”Ÿç”¢ç’°å¢ƒè² è¼‰å¹³è¡¡
  - name: docs-upstream-prod
    algorithm: round-robin
    hash_on: none
    hash_fallback: none
    hash_on_header: null
    hash_fallback_header: null
    hash_on_cookie: null
    hash_on_query_arg: null
    slots: 10000
    healthchecks:
      passive:
        type: http
        healthy:
          http_statuses: [200, 302]
          successes: 5
        unhealthy:
          http_statuses: [429, 500, 503, 504]
          tcp_failures: 3
          timeouts: 3
          http_failures: 5
      active:
        type: http
        timeout: 1
        concurrency: 10
        http_path: "/health"
        https_verify_certificate: false
        healthy:
          interval: 10
          http_statuses: [200]
          successes: 2
        unhealthy:
          interval: 5
          http_statuses: [429, 500, 502, 503, 504]
          tcp_failures: 2
          timeouts: 3
          http_failures: 5
    targets:
      - target: docs-service.aiot-prod.svc.cluster.local:3005
        weight: 100
    tags:
      - docs
      - upstream
      - production

# ==============================================
# ğŸ‘¤ æ¶ˆè²»è€…é…ç½® (Consumers) - Production
# ==============================================

consumers:
  # ç”Ÿç”¢ç’°å¢ƒ API é‡‘é‘°èªè­‰æ¶ˆè²»è€… (å¯é¸)
  - username: aiot-prod-api-client
    custom_id: "aiot-prod-001"
    tags:
      - production
      - api-client