# AIOT Kubernetes éƒ¨ç½² Makefile
# ä½¿ç”¨ Kustomize é€²è¡Œé…ç½®ç®¡ç†

.PHONY: help deploy deploy-mysql deploy-all clean update-configmaps

# é»˜èªç›®æ¨™
help:
	@echo "AIOT Kubernetes éƒ¨ç½²å‘½ä»¤ï¼š"
	@echo "  make deploy-mysql    - ä½¿ç”¨ Kustomize éƒ¨ç½² MySQL"
	@echo "  make deploy-all      - éƒ¨ç½²æ‰€æœ‰æœå‹™"
	@echo "  make update-configmaps - æ›´æ–°æ‰€æœ‰ ConfigMaps"
	@echo "  make clean           - æ¸…ç†éƒ¨ç½²"

# éƒ¨ç½² MySQL ä½¿ç”¨ Kustomize
deploy-mysql:
	@echo "ğŸš€ éƒ¨ç½² MySQL ä½¿ç”¨ Kustomize..."
	cd overlays/production/mysql && \
	if [ -f "generate-configmap.sh" ]; then ./generate-configmap.sh; fi && \
	kubectl apply -k .
	@echo "âœ… MySQL éƒ¨ç½²å®Œæˆ"

# æ›´æ–° ConfigMaps
update-configmaps:
	@echo "ğŸ”„ æ›´æ–° MySQL ConfigMaps..."
	cd overlays/production/mysql && ./generate-configmap.sh
	@echo "âœ… ConfigMaps æ›´æ–°å®Œæˆ"

# éƒ¨ç½²æ‰€æœ‰æœå‹™
deploy-all: deploy-mysql
	@echo "ğŸš€ éƒ¨ç½²æ‰€æœ‰ AIOT æœå‹™..."
	./deploy.sh

# æ¸…ç†éƒ¨ç½²
clean:
	@echo "ğŸ§¹ æ¸…ç† AIOT éƒ¨ç½²..."
	kubectl delete namespace aiot-prod --ignore-not-found=true
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æª¢æŸ¥ç‹€æ…‹
status:
	@echo "ğŸ“Š æª¢æŸ¥ AIOT æœå‹™ç‹€æ…‹..."
	kubectl get pods -n aiot-prod
	kubectl get services -n aiot-prod