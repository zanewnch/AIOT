apiVersion: v1
kind: ConfigMap
metadata:
  name: route-configs
  namespace: aiot-prod
  labels:
    app.kubernetes.io/name: route-configs
    app.kubernetes.io/component: configuration
    app.kubernetes.io/part-of: aiot-microservices
data:
  kong-main.yaml: |
    # ==============================================
    # Kong Gateway è²æ˜å¼é…ç½® - AIOT å¾®æœå‹™æ¶æ§‹
    # ==============================================
    # 
    # é…ç½®èªªæ˜ï¼š
    # â€¢ æ­¤æ–‡ä»¶æ•´åˆäº†æ‰€æœ‰ Kong Gateway é…ç½®
    # â€¢ æ”¯æ´ AIOT å¾®æœå‹™æ¶æ§‹çš„ API Gateway éœ€æ±‚
    # â€¢ åŒ…å«æœå‹™ç™¼ç¾ã€è·¯ç”±ã€æ’ä»¶ç­‰å®Œæ•´é…ç½®
    # 
    # æ¶æ§‹æ¦‚è¦½ï¼š
    # Kong Gateway â†’ å„å¾®æœå‹™
    # â€¢ /api/auth â†’ RBAC æœå‹™ (gRPC)
    # â€¢ /api/rbac â†’ RBAC æœå‹™ (gRPC) 
    # â€¢ /api/drone â†’ Drone æœå‹™ (gRPC)
    # â€¢ /socket.io â†’ Drone WebSocket æœå‹™ (HTTP + WebSocket å‡ç´š)
    # â€¢ /api/general â†’ General æœå‹™ (gRPC)
    # â€¢ /api/llm â†’ LLM æœå‹™ (gRPC)
    # â€¢ /docs â†’ æ–‡æª”æœå‹™ (HTTP)
    # â€¢ / â†’ é‡å®šå‘åˆ°æ–‡æª”æœå‹™
    #
    # ç¶²è·¯é…ç½®ï¼š
    # â€¢ ä½¿ç”¨ Docker Compose æœå‹™åç¨±é€²è¡Œå…§éƒ¨é€šè¨Š
    # â€¢ æ‰€æœ‰æœå‹™éƒ½åœ¨ aiot-network ç¶²è·¯ä¸­
    # â€¢ Kong é€é Docker å…§å»º DNS è§£ææœå‹™åç¨±

    _format_version: "3.0"

    # ==============================================
    # ğŸ”§ æœå‹™å®šç¾© (Services)
    # ==============================================

    services:
      # ğŸ” RBAC å¾®æœå‹™ - ä½¿ç”¨ gRPC å”è­°é€²è¡Œå…§éƒ¨é€šè¨Š
      - name: rbac-grpc-service
        protocol: grpc
        host: rbac-service
        port: 50051
        connect_timeout: 60000
        write_timeout: 60000
        read_timeout: 60000
        retries: 5
        tags:
          - auth
          - rbac
          - microservice
          - http

      # ğŸš Drone API å¾®æœå‹™ - ä½¿ç”¨ gRPC å”è­°è™•ç† API è«‹æ±‚
      - name: drone-grpc-service
        protocol: grpc
        host: drone-service
        port: 50052
        connect_timeout: 60000
        write_timeout: 60000
        read_timeout: 60000
        retries: 5
        tags:
          - drone
          - api
          - grpc

      # ğŸ“¡ Drone WebSocket å¾®æœå‹™ - å°ˆé–€è™•ç† WebSocket é€£ç·šï¼ˆé€é HTTP å‡ç´šæ©Ÿåˆ¶ï¼‰
      - name: drone-websocket-service
        protocol: http
        host: drone-websocket-service
        port: 3004
        connect_timeout: 60000
        write_timeout: 60000
        read_timeout: 60000
        retries: 5
        tags:
          - drone
          - websocket
          - realtime

      # âš™ï¸ General å¾®æœå‹™ - ä½¿ç”¨ gRPC å”è­°
      - name: general-service
        protocol: grpc
        host: general-service
        port: 50053
        connect_timeout: 60000
        write_timeout: 60000
        read_timeout: 60000
        retries: 5
        tags:
          - general
          - documentation
          - grpc

      # ğŸ“š æ–‡æª”æœå‹™ - çµ±ä¸€ç®¡ç†æ‰€æœ‰å¾®æœå‹™çš„ TypeDoc æ–‡æª”
      - name: docs-service
        protocol: http
        host: docs-service
        port: 3005
        connect_timeout: 60000
        write_timeout: 60000
        read_timeout: 60000
        retries: 5
        tags:
          - documentation
          - typedoc
          - static
          - http

      # ğŸ¤– LLM å¾®æœå‹™ - ä½¿ç”¨ HTTP å”è­°æä¾› AI/LLM åŠŸèƒ½ (Django)
      - name: llm-service
        protocol: http
        host: llm-service
        port: 8020
        connect_timeout: 60000
        write_timeout: 60000
        read_timeout: 60000
        retries: 5
        tags:
          - llm
          - ai
          - microservice
          - django
          - http

    # ==============================================
    # ğŸ›£ï¸ è·¯ç”±å®šç¾© (Routes)
    # ==============================================

    routes:
      # ğŸ” RBAC èªè­‰è·¯ç”± - æ”¯æ´ HTTP/HTTPS
      - name: rbac-auth-routes
        service: rbac-grpc-service
        paths:
          - /api/auth
        strip_path: true  # ç§»é™¤è·¯å¾‘å‰ç¶´ï¼Œè½‰ç™¼ä¹¾æ·¨è·¯å¾‘çµ¦å¾®æœå‹™
        preserve_host: false
        protocols:
          - http
          - https
        tags:
          - auth
          - login
          - gateway-only

      # ğŸ” RBAC ç®¡ç†è·¯ç”± - æ”¯æ´ HTTP/HTTPS
      - name: rbac-routes
        service: rbac-grpc-service
        paths:
          - /api/rbac
        strip_path: true   # ç§»é™¤ /api/rbac å‰ç¶´
        preserve_host: false
        protocols:
          - http
          - https
        tags:
          - rbac
          - permissions
          - gateway-only

      # ğŸš Drone API è·¯ç”± - æ”¯æ´ HTTP/HTTPSï¼Œé€£æ¥åˆ° gRPC æœå‹™
      - name: drone-api-routes
        service: drone-grpc-service
        paths:
          - /api/drone
        strip_path: true   # ç§»é™¤ /api/drone å‰ç¶´
        preserve_host: false
        protocols:
          - http
          - https
        tags:
          - drone
          - api
          - gateway-only
          - grpc

      # ğŸ“¡ Drone WebSocket è·¯ç”± - æ”¯æ´ HTTP/HTTPSï¼ˆWebSocket é€šé HTTP å‡ç´šæ©Ÿåˆ¶ï¼‰
      - name: drone-websocket-routes
        service: drone-websocket-service
        paths:
          - /socket.io
        strip_path: false   # ä¿æŒ /socket.io è·¯å¾‘ï¼ŒWebSocket éœ€è¦å®Œæ•´è·¯å¾‘
        preserve_host: false
        protocols:
          - http
          - https
        tags:
          - drone
          - websocket
          - realtime
          - gateway-only

      # âš™ï¸ General æ–‡æª”è·¯ç”± - æ”¯æ´ HTTP/HTTPS
      - name: general-docs-routes
        service: general-service
        paths:
          - /api/docs
        strip_path: true   # ç§»é™¤ /api/docs å‰ç¶´ï¼Œè½‰ç™¼ / çµ¦å¾®æœå‹™
        preserve_host: false
        protocols:
          - http
          - https
        tags:
          - general
          - documentation
          - gateway-only
          
      # âš™ï¸ General API è·¯ç”± - æ”¯æ´ HTTP/HTTPS  
      - name: general-api-routes
        service: general-service
        paths:
          - /api/general
        strip_path: true   # ç§»é™¤ /api/general å‰ç¶´ï¼Œè½‰ç™¼ / çµ¦å¾®æœå‹™
        preserve_host: false
        protocols:
          - http
          - https
        tags:
          - general
          - documentation
          - gateway-only

      # ğŸ’Š å¥åº·æª¢æŸ¥è·¯ç”± - å…§éƒ¨ä½¿ç”¨ï¼Œåƒ… HTTP
      - name: health-check-routes
        service: general-service
        paths:
          - /health
        strip_path: true   # ç§»é™¤ /health å‰ç¶´
        preserve_host: false
        protocols:
          - http
        tags:
          - health
          - internal

      # ğŸ“š æ–‡æª”æœå‹™è·¯ç”± - çµ±ä¸€çš„ TypeDoc æ–‡æª”å…¥å£
      - name: docs-service-routes
        service: docs-service
        paths:
          - /docs
        strip_path: true   # ç§»é™¤ /docs å‰ç¶´ï¼Œè½‰ç™¼ä¹¾æ·¨è·¯å¾‘çµ¦æ–‡æª”æœå‹™
        preserve_host: false
        protocols:
          - http
          - https
        tags:
          - documentation
          - typedoc
          - static
          - gateway-only

      # ğŸ¤– LLM API è·¯ç”± - æ”¯æ´ HTTP/HTTPSï¼Œé€£æ¥åˆ° Django æœå‹™
      - name: llm-api-routes
        service: llm-service
        paths:
          - /api/llm
        strip_path: true   # ç§»é™¤ /api/llm å‰ç¶´ï¼Œè½‰ç™¼ /api/ çµ¦ Django
        preserve_host: false
        protocols:
          - http
          - https
        tags:
          - llm
          - ai
          - api
          - gateway-only
          - django

      # ğŸ  æ ¹è·¯å¾‘è·¯ç”± - é‡å®šå‘åˆ°æ–‡æª”é é¢
      - name: root-route
        service: docs-service
        paths:
          - /
        strip_path: false  # ä¿æŒæ ¹è·¯å¾‘
        preserve_host: false
        protocols:
          - http
          - https
        tags:
          - root
          - documentation

    # ==============================================
    # ğŸ”Œ æ’ä»¶é…ç½® (Plugins)
    # ==============================================
    # 
    # ç›®å‰ä½¿ç”¨é è¨­æ’ä»¶é…ç½®
    # å¦‚éœ€å•Ÿç”¨ç‰¹å®šæ’ä»¶ï¼ˆå¦‚èªè­‰ã€é™æµç­‰ï¼‰ï¼Œåœ¨æ­¤è™•é…ç½®

    plugins: []

    # ==============================================
    # ğŸ¯ ä¸Šæ¸¸æœå‹™é…ç½® (Upstreams)
    # ==============================================
    # 
    # ç›®å‰ä½¿ç”¨ç›´æ¥æœå‹™é€£æ¥
    # å¦‚éœ€è² è¼‰å¹³è¡¡æˆ–æœå‹™ç™¼ç¾ï¼Œåœ¨æ­¤è™•é…ç½®

    upstreams: []

    # ==============================================
    # ğŸ‘¤ æ¶ˆè²»è€…é…ç½® (Consumers)  
    # ==============================================
    #
    # ç›®å‰ä¸éœ€è¦èªè­‰æ¶ˆè²»è€…
    # å¦‚éœ€ API Key æˆ– JWT èªè­‰ï¼Œåœ¨æ­¤è™•é…ç½®

    consumers: []

  kong-k8s.yaml: |
    # Kong API Gateway Kubernetes é…ç½®
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: kong-deployment
      namespace: aiot-prod
      labels:
        app: kong
        app.kubernetes.io/name: kong
        app.kubernetes.io/component: api-gateway
        app.kubernetes.io/part-of: aiot-microservices
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: kong
      template:
        metadata:
          labels:
            app: kong
        spec:
          containers:
          - name: kong
            image: kong:3.4
            ports:
            - containerPort: 8000
              name: proxy
            - containerPort: 8443
              name: proxy-ssl
            - containerPort: 8001
              name: admin
            - containerPort: 8444
              name: admin-ssl
            env:
            - name: KONG_DATABASE
              value: "off"
            - name: KONG_DECLARATIVE_CONFIG
              value: "/kong/kong.yaml"
            - name: KONG_PROXY_ACCESS_LOG
              value: "/dev/stdout"
            - name: KONG_ADMIN_ACCESS_LOG
              value: "/dev/stdout"
            - name: KONG_PROXY_ERROR_LOG
              value: "/dev/stderr"
            - name: KONG_ADMIN_ERROR_LOG
              value: "/dev/stderr"
            - name: KONG_ADMIN_LISTEN
              value: "0.0.0.0:8001, 0.0.0.0:8444 ssl"
            - name: KONG_PLUGINS
              value: "bundled"
            # ç§»é™¤è‡ªå®šç¾© DNS è§£æå™¨ï¼Œä½¿ç”¨ Kubernetes é»˜èª
            volumeMounts:
            - name: kong-config
              mountPath: /kong
              readOnly: true
            - name: kong-protos
              mountPath: /kong/protos
              readOnly: true
            livenessProbe:
              exec:
                command:
                - kong
                - health
              initialDelaySeconds: 30
              periodSeconds: 10
              timeoutSeconds: 5
              failureThreshold: 3
            readinessProbe:
              httpGet:
                path: /status
                port: 8001
              initialDelaySeconds: 10
              periodSeconds: 10
              timeoutSeconds: 5
              failureThreshold: 3
            resources:
              requests:
                memory: "512Mi"
                cpu: "300m"
              limits:
                memory: "1Gi"
                cpu: "600m"
          volumes:
          - name: kong-config
            configMap:
              name: kong-config
          - name: kong-protos
            configMap:
              name: kong-protos
          restartPolicy: Always

    ---
    apiVersion: v1
    kind: Service
    metadata:
      name: kong-service
      namespace: aiot-prod
      labels:
        app: kong
        app.kubernetes.io/name: kong
        app.kubernetes.io/component: api-gateway
    spec:
      selector:
        app: kong
      ports:
      - port: 8000
        targetPort: 8000
        protocol: TCP
        name: proxy
      - port: 8443
        targetPort: 8443
        protocol: TCP
        name: proxy-ssl
      - port: 8001
        targetPort: 8001
        protocol: TCP
        name: admin
      - port: 8444
        targetPort: 8444
        protocol: TCP
        name: admin-ssl
      type: ClusterIP

    ---
    # Kong å°å¤–æš´éœ²æœå‹™ (LoadBalancer æˆ– NodePort)
    apiVersion: v1
    kind: Service
    metadata:
      name: kong-external-service
      namespace: aiot-prod
      labels:
        app: kong
        app.kubernetes.io/name: kong
        app.kubernetes.io/component: api-gateway-external
    spec:
      selector:
        app: kong
      ports:
      - port: 8000
        targetPort: 8000
        protocol: TCP
        name: proxy
        nodePort: 30000
      - port: 8001
        targetPort: 8001
        protocol: TCP
        name: admin
        nodePort: 30001
      type: NodePort

  consul-main.json: |
    {
      "datacenter": "dc1",
      "data_dir": "/consul/data",
      "log_level": "INFO",
      "node_name": "consul-server",
      "bind_addr": "0.0.0.0",
      "client_addr": "0.0.0.0",
      "retry_join": ["consul"],
      "server": true,
      "bootstrap_expect": 1,
      "ui_config": {
        "enabled": true
      },
      "connect": {
        "enabled": true
      },
      "ports": {
        "grpc": 8502
      },
      "acl": {
        "enabled": false,
        "default_policy": "allow",
        "enable_token_persistence": true
      },
      "performance": {
        "raft_multiplier": 1
      },
      "autopilot": {
        "cleanup_dead_servers": true,
        "last_contact_threshold": "200ms",
        "max_trailing_logs": 250,
        "server_stabilization_time": "10s",
        "disable_upgrade_migration": false
      }
    }

  consul-k8s.yaml: |
    # Consul æœå‹™ç™¼ç¾ Kubernetes é…ç½®
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: consul-deployment
      namespace: aiot-prod
      labels:
        app: consul
        app.kubernetes.io/name: consul
        app.kubernetes.io/component: service-discovery
        app.kubernetes.io/part-of: aiot-microservices
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: consul
      template:
        metadata:
          labels:
            app: consul
        spec:
          containers:
          - name: consul
            image: consul:1.15
            ports:
            - containerPort: 8500
              name: http-api
            - containerPort: 8600
              name: dns
              protocol: UDP
            env:
            - name: CONSUL_BIND_INTERFACE
              value: "eth0"
            volumeMounts:
            - name: consul-storage
              mountPath: /consul/data
            - name: consul-config
              mountPath: /consul/config/consul.json
              subPath: consul.json
              readOnly: true
            - name: consul-services
              mountPath: /consul/config/services
              readOnly: true
            livenessProbe:
              exec:
                command:
                - consul
                - members
              initialDelaySeconds: 30
              periodSeconds: 10
              timeoutSeconds: 5
              failureThreshold: 3
            readinessProbe:
              httpGet:
                path: /v1/status/leader
                port: 8500
              initialDelaySeconds: 10
              periodSeconds: 10
              timeoutSeconds: 5
              failureThreshold: 3
            resources:
              requests:
                memory: "256Mi"
                cpu: "200m"
              limits:
                memory: "512Mi"
                cpu: "400m"
          volumes:
          - name: consul-storage
            persistentVolumeClaim:
              claimName: consul-pvc
          - name: consul-config
            configMap:
              name: consul-config
          - name: consul-services
            configMap:
              name: consul-services
          restartPolicy: Always

    ---
    apiVersion: v1
    kind: Service
    metadata:
      name: consul-service
      namespace: aiot-prod
      labels:
        app: consul
        app.kubernetes.io/name: consul
        app.kubernetes.io/component: service-discovery
    spec:
      selector:
        app: consul
      ports:
      - port: 8500
        targetPort: 8500
        protocol: TCP
        name: http-api
      - port: 8600
        targetPort: 8600
        protocol: UDP
        name: dns
      type: ClusterIP

  consul-rbac-service.json: |
    {
      "service": {
        "id": "rbac-service",
        "name": "rbac-service",
        "tags": [
          "auth",
          "rbac",
          "microservice",
          "nodejs",
          "express"
        ],
        "address": "rbac-service",
        "port": 50051,
        "meta": {
          "version": "1.0.0",
          "env": "development",
          "protocols": "grpc"
        },
        "check": {
          "id": "rbac-service-health",
          "name": "RBAC Service Health Check",
          "grpc": "rbac-service:50051",
          "interval": "10s",
          "timeout": "3s",
          "deregister_critical_service_after": "30s"
        },
        "checks": [
          {
            "id": "rbac-service-api",
            "name": "RBAC API Check",
            "grpc": "rbac-service:50051",
            "interval": "30s",
            "timeout": "5s"
          },
          {
            "id": "rbac-service-grpc",
            "name": "RBAC gRPC Check",
            "grpc": "rbac-service:50051",
            "interval": "30s",
            "timeout": "5s"
          }
        ],
        "weights": {
          "passing": 10,
          "warning": 1
        }
      }
    }

  consul-drone-service.json: |
    {
      "service": {
        "id": "drone-service",
        "name": "drone-service",
        "tags": [
          "drone",
          "iot",
          "api",
          "microservice",
          "nodejs",
          "grpc"
        ],
        "address": "drone-service",
        "port": 50052,
        "meta": {
          "version": "1.0.0",
          "env": "development",
          "protocols": "grpc"
        },
        "check": {
          "id": "drone-service-grpc",
          "name": "Drone gRPC Health Check",
          "grpc": "drone-service:50052",
          "interval": "10s",
          "timeout": "3s",
          "deregister_critical_service_after": "30s"
        },
        "checks": [
          {
            "id": "drone-service-grpc-health",
            "name": "Drone gRPC Health Check",
            "grpc": "drone-service:50052",
            "interval": "30s",
            "timeout": "5s"
          }
        ],
        "weights": {
          "passing": 10,
          "warning": 1
        }
      }
    }