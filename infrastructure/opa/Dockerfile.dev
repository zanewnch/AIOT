# AIOT OPA - Development Dockerfile
# ⚙️ 開發環境專用，支援 gRPC + HTTP API + 健康檢查工具

# 使用 Alpine 作為基礎來添加工具，然後複製 OPA
FROM alpine:3.18 as tools
RUN apk add --no-cache \
    curl \
    wget \
    netcat-openbsd \
    bind-tools

FROM openpolicyagent/opa:latest-envoy as development

# 從 tools 階段複製工具和依賴庫
USER root
COPY --from=tools /usr/bin/curl /usr/bin/curl
COPY --from=tools /usr/bin/wget /usr/bin/wget
COPY --from=tools /usr/bin/nc /usr/bin/nc
COPY --from=tools /usr/bin/nslookup /usr/bin/nslookup
COPY --from=tools /lib /lib
COPY --from=tools /usr/lib /usr/lib

# 保持使用 root 用戶 (開發環境)

# 開發端口 (HTTP API + gRPC Envoy)
EXPOSE 8181 9191

# 健康檢查 - 包含 bundle 狀態檢查
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:8181/health?bundle=true || exit 1

# 開發環境啟動命令 (與原始保持一致)
ENTRYPOINT ["/opa"]