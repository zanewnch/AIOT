# AIOT LLM Service - Production Dockerfile
# ğŸ¤– ç”Ÿç”¢ç’°å¢ƒå°ˆç”¨ï¼ŒDjango REST API æœå‹™

FROM python:3.11-slim-bullseye as production

# è¨­å®šç’°å¢ƒè®Šæ•¸
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    DJANGO_SETTINGS_MODULE=llm.settings \
    PYTHONPATH=/app

# å®‰è£ç³»çµ±ä¾è³´
RUN apt-get update && apt-get install -y \
    curl \
    netcat \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# å‰µå»ºé root ç”¨æˆ¶ (å®‰å…¨æœ€ä½³å¯¦è¸)
RUN groupadd -g 1001 pythonuser && useradd -r -u 1001 -g pythonuser pythonuser

# è¨­å®šå·¥ä½œç›®éŒ„
WORKDIR /app

# è¤‡è£½ requirements ä¸¦å®‰è£ Python ä¾è³´
COPY requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt

# è¤‡è£½æ‡‰ç”¨ç¨‹å¼ç¢¼
COPY . .

# è¨­ç½®æ­£ç¢ºçš„æª”æ¡ˆæ¬Šé™
RUN chown -R pythonuser:pythonuser /app

# åˆ‡æ›åˆ°é root ç”¨æˆ¶
USER pythonuser

# æ”¶é›†éœæ…‹æª”æ¡ˆ (Django ç”Ÿç”¢éƒ¨ç½²éœ€è¦)
RUN python manage.py collectstatic --noinput

# åŸ·è¡Œè³‡æ–™åº«é·ç§»
RUN python manage.py migrate

# ç”Ÿç”¢ç«¯å£
EXPOSE 8022

# å¥åº·æª¢æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:8022/api/transformers/health/ || exit 1

# ç”Ÿç”¢ç’°å¢ƒå•Ÿå‹•å‘½ä»¤
CMD ["gunicorn", "--bind", "0.0.0.0:8022", "--workers", "4", "--timeout", "60", "llm.wsgi:application"]