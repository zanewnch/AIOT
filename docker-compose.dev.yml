# AIOT Microservices - Development Environment
# ğŸ³ Docker Compose for Development Only
#
# ç‰¹æ€§ï¼š
# â€¢ Hot-Reload æ”¯æ´
# â€¢ é™¤éŒ¯ç«¯å£é–‹æ”¾
# â€¢ Volume æ›è¼‰å³æ™‚åŒæ­¥
# â€¢ è³‡æºç„¡é™åˆ¶
# â€¢ é–‹ç™¼è€…å‹å¥½é…ç½®

version: '3.8'

networks:
  aiot-dev-network:
    driver: bridge
    name: aiot-dev-network

volumes:
  # Node.js å¾®æœå‹™ node_modules å¿«å–
  node_modules_rbac:
  node_modules_drone:
  node_modules_drone_websocket:
  node_modules_general:
  node_modules_docs:
  
  # è³‡æ–™åº«æŒä¹…åŒ– Volume
  mysql_dev_data:
  mongodb_dev_data:
  redis_dev_data:
  
  # ç›£æ§èˆ‡æ—¥èªŒ
  prometheus_dev_data:

services:
  # ==============================================
  # ğŸ—„ï¸ è³‡æ–™åº«æœå‹™ (Development)
  # ==============================================
  
  # MySQL ä¸»è¦è³‡æ–™åº«
  mysql-dev:
    image: mysql:8.0
    container_name: aiot-mysql-dev
    environment:
      MYSQL_ROOT_PASSWORD: aiot_dev_root_2024
      MYSQL_DATABASE: aiot_development
      MYSQL_USER: aiot_dev_user
      MYSQL_PASSWORD: aiot_dev_password
    ports:
      - "3306:3306"  # é–‹ç™¼ç’°å¢ƒé–‹æ”¾ç«¯å£
    volumes:
      - mysql_dev_data:/var/lib/mysql
      - ./infrastructure/database/mysql:/docker-entrypoint-initdb.d:ro
    networks:
      - aiot-dev-network
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  # MongoDB æª”æ¡ˆè³‡æ–™åº«
  mongodb-dev:
    image: mongo:7.0
    container_name: aiot-mongodb-dev
    environment:
      MONGO_INITDB_ROOT_USERNAME: aiot_dev_admin
      MONGO_INITDB_ROOT_PASSWORD: aiot_dev_mongo_2024
      MONGO_INITDB_DATABASE: aiot_development
    ports:
      - "27017:27017"  # é–‹ç™¼ç’°å¢ƒé–‹æ”¾ç«¯å£
    volumes:
      - mongodb_dev_data:/data/db
    networks:
      - aiot-dev-network

  # Redis å¿«å–æœå‹™
  redis-dev:
    image: redis:7.2-alpine
    container_name: aiot-redis-dev
    ports:
      - "6379:6379"  # é–‹ç™¼ç’°å¢ƒé–‹æ”¾ç«¯å£
    volumes:
      - redis_dev_data:/data
    networks:
      - aiot-dev-network
    command: redis-server --appendonly yes --requirepass aiot_dev_redis_2024

  # ==============================================
  # ğŸ³ å¾®æœå‹™ (Development with Hot-Reload)
  # ==============================================

  # ğŸ” RBAC èªè­‰èˆ‡æ¬Šé™æœå‹™ (Express.js + nodemon)
  rbac-service-dev:
    build:
      context: ./microServices/rbac-service
      dockerfile: Dockerfile.dev
      target: development
    container_name: aiot-rbac-dev
    ports:
      - "3001:3001"     # HTTP API ç«¯å£
      - "9229:9229"     # Node.js Debug ç«¯å£
    volumes:
      - ./microServices/rbac-service/src:/app/src:rw
      - ./microServices/rbac-service/package.json:/app/package.json:ro
      - ./microServices/rbac-service/tsconfig.json:/app/tsconfig.json:ro
      - ./shared:/app/shared:ro
      - node_modules_rbac:/app/node_modules
    environment:
      - NODE_ENV=development
      - PORT=3001
      - DB_HOST=mysql-dev
      - DB_PORT=3306
      - DB_NAME=aiot_development
      - DB_USER=aiot_dev_user
      - DB_PASSWORD=aiot_dev_password
      - JWT_SECRET=aiot_dev_jwt_secret_2024
      - REDIS_HOST=redis-dev
      - REDIS_PORT=6379
      - REDIS_PASSWORD=aiot_dev_redis_2024
    networks:
      - aiot-dev-network
    depends_on:
      - mysql-dev
      - redis-dev
    command: npm run dev
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ğŸš Drone æœå‹™ (Express.js + gRPC + nodemon)
  drone-service-dev:
    build:
      context: ./microServices/drone-service
      dockerfile: Dockerfile.dev
      target: development
    container_name: aiot-drone-dev
    ports:
      - "3002:3002"     # HTTP API ç«¯å£
      - "50052:50052"   # gRPC ç«¯å£
      - "9230:9229"     # Node.js Debug ç«¯å£
    volumes:
      - ./microServices/drone-service/src:/app/src:rw
      - ./microServices/drone-service/package.json:/app/package.json:ro
      - ./microServices/drone-service/tsconfig.json:/app/tsconfig.json:ro
      - ./shared:/app/shared:ro
      - node_modules_drone:/app/node_modules
    environment:
      - NODE_ENV=development
      - HTTP_PORT=3002
      - GRPC_PORT=50052
      - DB_HOST=mysql-dev
      - DB_PORT=3306
      - DB_NAME=aiot_development
      - DB_USER=aiot_dev_user
      - DB_PASSWORD=aiot_dev_password
      - MONGO_HOST=mongodb-dev
      - MONGO_PORT=27017
      - MONGO_DB=aiot_development
      - MONGO_USER=aiot_dev_admin
      - MONGO_PASSWORD=aiot_dev_mongo_2024
    networks:
      - aiot-dev-network
    depends_on:
      - mysql-dev
      - mongodb-dev
    command: npm run dev
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ğŸ“¡ Drone WebSocket æœå‹™ (Socket.IO + nodemon)
  drone-websocket-dev:
    build:
      context: ./microServices/drone-websocket-service
      dockerfile: Dockerfile.dev
      target: development
    container_name: aiot-drone-websocket-dev
    ports:
      - "3004:3004"     # WebSocket ç«¯å£
      - "9231:9229"     # Node.js Debug ç«¯å£
    volumes:
      - ./microServices/drone-websocket-service/src:/app/src:rw
      - ./microServices/drone-websocket-service/package.json:/app/package.json:ro
      - ./microServices/drone-websocket-service/tsconfig.json:/app/tsconfig.json:ro
      - ./shared:/app/shared:ro
      - node_modules_drone_websocket:/app/node_modules
    environment:
      - NODE_ENV=development
      - PORT=3004
      - REDIS_HOST=redis-dev
      - REDIS_PORT=6379
      - REDIS_PASSWORD=aiot_dev_redis_2024
    networks:
      - aiot-dev-network
    depends_on:
      - redis-dev
    command: npm run dev

  # âš™ï¸ General æœå‹™ (Express.js + gRPC + nodemon)
  general-service-dev:
    build:
      context: ./microServices/general-service
      dockerfile: Dockerfile.dev
      target: development
    container_name: aiot-general-dev
    ports:
      - "3003:3003"     # HTTP API ç«¯å£
      - "50053:50053"   # gRPC ç«¯å£
      - "9232:9229"     # Node.js Debug ç«¯å£
    volumes:
      - ./microServices/general-service/src:/app/src:rw
      - ./microServices/general-service/package.json:/app/package.json:ro
      - ./microServices/general-service/tsconfig.json:/app/tsconfig.json:ro
      - ./shared:/app/shared:ro
      - node_modules_general:/app/node_modules
    environment:
      - NODE_ENV=development
      - HTTP_PORT=3003
      - GRPC_PORT=50053
      - DB_HOST=mysql-dev
      - DB_PORT=3306
      - DB_NAME=aiot_development
      - DB_USER=aiot_dev_user
      - DB_PASSWORD=aiot_dev_password
    networks:
      - aiot-dev-network
    depends_on:
      - mysql-dev
    command: npm run dev
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3003/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ğŸ“š Docs æœå‹™ (Express.js + nodemon)
  docs-service-dev:
    build:
      context: ./microServices/docs-service
      dockerfile: Dockerfile.dev
      target: development
    container_name: aiot-docs-dev
    ports:
      - "3005:3005"     # HTTP ç«¯å£
      - "9233:9229"     # Node.js Debug ç«¯å£
    volumes:
      - ./microServices/docs-service/src:/app/src:rw
      - ./microServices/docs-service/package.json:/app/package.json:ro
      - ./microServices/docs-service/tsconfig.json:/app/tsconfig.json:ro
      - ./microServices/docs-service/docs:/app/docs:rw
      - node_modules_docs:/app/node_modules
    environment:
      - NODE_ENV=development
      - PORT=3005
    networks:
      - aiot-dev-network
    command: npm run dev
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3005/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ğŸ¤– LLM æœå‹™ (Django + runserver)
  llm-service-dev:
    build:
      context: ./microServices/llm-service
      dockerfile: Dockerfile.dev
      target: development
    container_name: aiot-llm-dev
    ports:
      - "8020:8020"     # Django é–‹ç™¼ä¼ºæœå™¨
      - "5678:5678"     # Python Debug ç«¯å£
    volumes:
      - ./microServices/llm-service:/app:rw
      - /app/venv        # æ’é™¤è™›æ“¬ç’°å¢ƒ
    environment:
      - DJANGO_ENV=development
      - DEBUG=True
      - ALLOWED_HOSTS=localhost,127.0.0.1,llm-service-dev
      - DATABASE_URL=sqlite:///app/db.sqlite3
      - CHROMA_PERSIST_DIRECTORY=/app/chroma_db
    networks:
      - aiot-dev-network
    command: python manage.py runserver 0.0.0.0:8020
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8020/api/health/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==============================================
  # ğŸŒ API Gateway (Development)
  # ==============================================

  # Kong Gateway é–‹ç™¼é…ç½®
  kong-dev:
    image: kong:3.4
    container_name: aiot-kong-dev
    ports:
      - "8000:8000"     # Proxy ç«¯å£
      - "8001:8001"     # Admin API ç«¯å£
    volumes:
      - ./infrastructure/kong/kong.yaml:/kong/declarative/kong.yaml:ro
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/declarative/kong.yaml
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: '0.0.0.0:8001'
      KONG_PLUGINS: bundled
      # é–‹ç™¼ç’°å¢ƒèª¿è©¦è¨­å®š
      KONG_LOG_LEVEL: debug
      KONG_NGINX_WORKER_PROCESSES: 1
      KONG_MEM_CACHE_SIZE: 32m
    networks:
      - aiot-dev-network
    depends_on:
      - rbac-service-dev
      - drone-service-dev
      - drone-websocket-dev
      - general-service-dev
      - llm-service-dev
      - docs-service-dev
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==============================================
  # ğŸ“Š ç›£æ§ & é–‹ç™¼å·¥å…· (Optional)
  # ==============================================

  # Prometheus (è¼•é‡é–‹ç™¼ç›£æ§)
  prometheus-dev:
    image: prom/prometheus:latest
    container_name: aiot-prometheus-dev
    ports:
      - "9090:9090"
    volumes:
      - ./infrastructure/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_dev_data:/prometheus
    networks:
      - aiot-dev-network
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    profiles:
      - monitoring

  # Grafana (é–‹ç™¼ç’°å¢ƒç›£æ§é¢æ¿)
  grafana-dev:
    image: grafana/grafana:latest
    container_name: aiot-grafana-dev
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: aiot_dev_grafana_2024
    volumes:
      - grafana_dev_data:/var/lib/grafana
    networks:
      - aiot-dev-network
    profiles:
      - monitoring